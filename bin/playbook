#!/usr/bin/env bash
set -eo pipefail

if [ -L $0 ]; then
    ROOT=$(cd $(dirname $(readlink -e $0))/..; pwd)
else
    ROOT=$(cd $(dirname $0)/..; pwd)
fi

if ! hash ansible-playbook 2>/dev/null; then
    echo "Failed to detect ansible-playbook!"
    exit 1
fi

if test -f ${ROOT}/.vaultpasswd; then
    VAULT_PASSWORD_FILE=${ROOT}/.vaultpasswd
else
    if test -z "${ANSIBLE_VAULT_PASSWORD}"; then
        echo "Missing ANSIBLE_VAULT_PASSWORD!"
        exit 2
    fi

    VAULT_PASSWORD_FILE=$(mktemp)
    echo ${ANSIBLE_VAULT_PASSWORD} >| ${VAULT_PASSWORD_FILE}
fi

pushd ${ROOT} >/dev/null
    exec ansible-playbook \
        --vault-password-file ${VAULT_PASSWORD_FILE} \
        --inventory-file ansible/inventory/static \
        ansible/playbook.yml \
        "$@"
popd >/dev/null
